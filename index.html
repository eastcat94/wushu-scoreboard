<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>实时成绩看板</title>
<style>
  :root{--bg:#071226;--card:#0d1b2a;--accent:#f4c94e;--muted:#97a0b3;color-scheme:dark}
  html,body{height:100%;margin:0;font-family: "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;background:var(--bg);color:#fff}
  .wrap{max-width:1280px;margin:18px auto;padding:28px;box-sizing:border-box}
  header{text-align:center;margin-bottom:6px}
  header img{max-width:480px;height:auto;display:inline-block;border:4px solid #fff}
  .title{font-size:56px;font-weight:800;margin:12px 0 6px;text-align:center}
  .top-number{font-size:48px;font-weight:700;text-align:center;margin:6px 0}
  .name-eng{font-size:36px;font-weight:800;text-align:center;margin:6px 0}
  .name-chn{font-size:32px;text-align:center;margin:6px 0;color:var(--muted)}
  .club{font-size:20px;text-align:center;margin:6px 0;color:var(--muted)}
  .scores-row{display:flex;gap:18px;justify-content:center;align-items:stretch;margin-top:26px}
  .score-card{background:var(--card);padding:26px;border-radius:10px;min-width:220px;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
  .label{font-size:14px;color:var(--muted);margin-bottom:6px;text-align:center}
  .value{font-size:36px;font-weight:900;text-align:center}
  .final-label{display:inline-block;background:var(--accent);color:#000;padding:10px 16px;border-radius:8px;font-weight:700;margin-top:22px}
  .final-score{font-size:120px;font-weight:900;color:var(--accent);margin:20px 0 8px;text-align:center}
  .meta{font-size:13px;color:var(--muted);text-align:center;margin-top:10px}
  .debug{position:fixed;right:12px;top:12px;background:#fff;color:#000;padding:10px;border-radius:8px;font-size:12px;z-index:9999;max-width:420px;overflow:auto}
  @media(max-width:900px){
    .title{font-size:34px}
    .final-score{font-size:64px}
    .scores-row{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- 如果你上传有 banner，请把文件名改成这里的 src，或改为线上 URL -->
      <img id="banner" src="./jun-wei-banner.jpg" alt="banner" />
    </header>

    <!-- 第一排：B1（将被覆盖为 sheet 的 B1 文本） -->
    <div class="title" id="sheetTitle">—</div>

    <!-- 第二排：B2 英文名 -->
    <div class="name-eng" id="nameEng">—</div>

    <!-- 第三排：B3 中文名 -->
    <div class="name-chn" id="nameChn">—</div>

    <!-- 第四排：B4 学校 -->
    <div class="club" id="club">—</div>

    <!-- 第五排：固定标题（页面固定显示） -->
    <div class="scores-row" style="margin-top:18px">
      <div class="score-card">
        <div class="label">A组得分</div>
        <div class="value" id="valA">—</div>
      </div>
      <div class="score-card">
        <div class="label">Final Score 最终得分</div>
        <div class="value" id="valFinalSmall">—</div>
      </div>
      <div class="score-card">
        <div class="label">B组得分</div>
        <div class="value" id="valB">—</div>
      </div>
    </div>

    <!-- 第七排：黄色固定方块 -->
    <div style="text-align:center;margin-top:18px">
      <span class="final-label">Final Score 最终得分</span>
    </div>

    <!-- 第八排：最终大分（B8） -->
    <div class="final-score" id="finalScore">—</div>

    <div class="meta">最后更新时间：<span id="updatedAt">-</span></div>
  </div>

  <!-- Debug 面板（部署时可折叠或设为 false） -->
  <div class="debug" id="debugBox" style="display:none">
    <div><strong>Debug</strong></div>
    <div>GViz URL: <a id="gvizLink" href="#" target="_blank" rel="noopener noreferrer"></a></div>
    <div id="netStatus">状态: 等待</div>
    <pre id="netError" style="white-space:pre-wrap;color:#900"></pre>
  </div>

<script>
/*
全新从头实现（固定映射）
映射（你最后确认的）：
 - B1 -> 页面第一排 title (rows[0].c[0])
 - B2 -> rows[1].c[0] -> 英文名 (nameEng)
 - B3 -> rows[2].c[0] -> 中文名 (nameChn)
 - B4 -> rows[3].c[0] -> 学校 (club)
 - 第五排 页面固定显示 A组/B组/裁判长扣分（不从 sheet 读取）
 - 第六排数值：
     B6 -> rows[5].c[0]  (A组分数)
     C6 -> rows[5].c[1]  (B组分数)
     C7 -> rows[6].c[1]  (裁判长扣分)  <-- 按你指定使用C7
 - 第七排 页面固定黄色方块文本（Final Score 最终得分）
 - 第八排最终分数：B8 -> rows[7].c[0]
先决条件：请确保你的 Google Sheet 已 Publish to the web 或 Share 为 Anyone with link can view
*/

const SPREADSHEET_ID = "1qGA-x86Xt7qEXwzO_Nx0RwaFr7yO2x3kocqA_nTfA0w";
const GID = "387691548";
const INTERVAL_MS = 3000; // 刷新间隔（毫秒）

const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
const SHOW_DEBUG = true;

// 显示 debug 面板并填入 gviz URL
if (SHOW_DEBUG) {
  const d = document.getElementById('debugBox');
  if (d) {
    d.style.display = 'block';
    document.getElementById('gvizLink').innerText = GVIZ_URL;
    document.getElementById('gvizLink').href = GVIZ_URL;
  }
}

function setStatus(txt){ if (SHOW_DEBUG) document.getElementById('netStatus').innerText = '状态: ' + txt; }
function setError(txt){ if (SHOW_DEBUG) document.getElementById('netError').innerText = txt; console.error(txt); }

function parseGvizText(txt){
  const jsonText = txt.replace(/^[\s\S]*?google\.visualization\.Query\.setResponse\(/, '').replace(/\);?\s*$/, '');
  return JSON.parse(jsonText);
}
function safeCell(rows, r, c){
  if (!rows || !rows[r] || !rows[r].c) return null;
  const cell = rows[r].c[c];
  if (!cell) return null;
  return (cell.v !== undefined) ? cell.v : (cell.f !== undefined ? cell.f : null);
}
function formatScore(v){
  if (v === null || v === undefined || v === '') return '—';
  const n = Number(v);
  if (!isNaN(n)) return (n % 1 === 0) ? n.toFixed(0) : n.toFixed(2);
  return String(v);
}

async function fetchAndRender(){
  setStatus('请求中...');
  setError('');
  try {
    const res = await fetch(GVIZ_URL, {cache:'no-store'});
    setStatus('HTTP ' + res.status);
    if (!res.ok) {
      const txt = await res.text().catch(()=>'');
      setError('请求失败 HTTP ' + res.status + '\n' + txt.slice(0,800));
      return;
    }
    const txt = await res.text();
    const data = parseGvizText(txt);
    if (!data || !data.table || !data.table.rows) {
      setError('返回数据缺少 table.rows，请检查 sheet 是否已发布或权限。返回片段:\n' + (txt||'').slice(0,300));
      return;
    }
    const rows = data.table.rows;

    // 映射并写入 DOM（按你指定的单元格）
    // B1 -> rows[0].c[0]
    const B1 = safeCell(rows,0,0);
    document.getElementById('sheetTitle').innerText = (B1 && String(B1).trim() !== '') ? String(B1) : '—';

    // B2 / B3 / B4
    document.getElementById('nameEng').innerText = String(safeCell(rows,1,0) || '—');
    document.getElementById('nameChn').innerText = String(safeCell(rows,2,0) || '—');
    document.getElementById('club').innerText = String(safeCell(rows,3,0) || '—');

    // 第五排固定标题（不读取）
    // 第六排读取 B6, C6, C7
    const rawA = safeCell(rows,5,0); // B6
    const rawB = safeCell(rows,5,1); // C6
    const rawPenalty = safeCell(rows,6,1); // C7 (按你要求)
    document.getElementById('valA').innerText = formatScore(rawA);
    document.getElementById('valB').innerText = formatScore(rawB);
    document.getElementById('valFinalSmall').innerText = formatScore(rawB); // small center shows Final label's small value (optional)
    document.getElementById('valPenalty').innerText = formatScore(rawPenalty); // (not visible in current layout but kept for completeness)

    // 第七排固定黄色方块（不读取）
    // 第八排：最终分数 B8
    const finalVal = safeCell(rows,7,0); // B8
    document.getElementById('finalScore').innerText = formatScore(finalVal);

    document.getElementById('updatedAt').innerText = new Date().toLocaleString();

    // Debug 输出（便于确认）
    const dbg = [
      'rows.length=' + (rows ? rows.length : 0),
      `B1='${safeCell(rows,0,0)}'`,
      `B2='${safeCell(rows,1,0)}'`,
      `B3='${safeCell(rows,2,0)}'`,
      `B4='${safeCell(rows,3,0)}'`,
      `B6='${safeCell(rows,5,0)}'`,
      `C6='${safeCell(rows,5,1)}'`,
      `C7='${safeCell(rows,6,1)}'`,
      `B8='${safeCell(rows,7,0)}'`
    ].join('\n');
    setStatus('解析并更新成功');
    if (SHOW_DEBUG) setError('Mapping debug:\n' + dbg);

  } catch (err) {
    setError('Fetch/解析异常: ' + err.toString());
  }
}

fetchAndRender();
setInterval(fetchAndRender, INTERVAL_MS);
</script>

</body>
</html>
