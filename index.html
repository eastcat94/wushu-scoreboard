<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wushu Scoreboard</title>
<style>
    body {
        background: #0d1726;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
    }
    .container {
        padding-top: 20px;
    }
    .banner img {
        width: 60%;
        max-width: 650px;
    }
    .title {
        font-size: 48px;
        font-weight: 900;
        margin-top: 20px;
    }
    .name-eng {
        font-size: 42px;
        font-weight: 700;
        margin-top: 20px;
    }
    .name-chn {
        font-size: 38px;
        font-weight: 700;
        margin-top: 10px;
    }
    .club {
        font-size: 30px;
        margin-top: 10px;
    }

    .score-row {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
    }
    .score-box {
        width: 260px;
        background: #111f33;
        padding: 20px;
        border-radius: 10px;
    }
    .score-label {
        font-size: 22px;
        opacity: 0.8;
    }
    .score-value {
        margin-top: 10px;
        font-size: 36px;
        font-weight: bold;
    }

    .yellow-btn {
        margin-top: 40px;
        background: #f5cf48;
        color: black;
        font-size: 22px;
        padding: 12px 30px;
        border-radius: 10px;
        display: inline-block;
        font-weight: bold;
    }

    .final-score-big {
        margin-top: 25px;
        font-size: 72px;
        font-weight: 900;
        color: #f6d46c;
    }

    .meta {
        margin-top: 40px;
        font-size: 14px;
        opacity: 0.8;
    }

    /* Debug box */
    #debugBox {
        position: fixed;
        top: 10px;
        right: 10px;
        width: 420px;
        background: #ffffff22;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        text-align: left;
        display: none;
        white-space: pre-wrap;
    }
</style>
</head>
<body>

<div class="container">
    <div class="banner">
        <img src="jun-wei-banner.jpg" />
    </div>

    <!-- 第一排 -->
    <div id="sheetTitle" class="title">——</div>

    <!-- 第二排 英文名 -->
    <div id="nameEng" class="name-eng">——</div>

    <!-- 第三排 中文名 -->
    <div id="nameChn" class="name-chn">——</div>

    <!-- 第四排 学校 -->
    <div id="club" class="club">——</div>

    <!-- 第五排 固定 -->
    <div class="score-row" style="margin-top: 50px;">
        <div class="score-box">
            <div class="score-label">A组得分</div>
            <div id="valA" class="score-value">—</div>
        </div>
        <div class="score-box">
            <div class="score-label">B组得分</div>
            <div id="valB" class="score-value">—</div>
        </div>
        <div class="score-box">
            <div class="score-label">裁判长扣分</div>
            <div id="valPenalty" class="score-value">—</div>
        </div>
    </div>

    <!-- 第七排 黄色按钮 -->
    <div class="yellow-btn">Final Score 最终得分</div>

    <!-- 第八排 最后一分 -->
    <div id="finalScore" class="final-score-big">—</div>

    <div class="meta">最后更新: <span id="updatedAt">—</span></div>
</div>

<!-- Debug -->
<div id="debugBox">
<strong>Debug 信息</strong>
<div id="netStatus"></div>
<div id="netError"></div>
</div>

<script>
/* ★★★★★ 你的 Google Sheet 参数 ★★★★★ */
const SPREADSHEET_ID = "1qGA-x86Xt7qEXwzO_Nx0RwaFr7yO2x3kocqA_nTfA0w";
const GID = "387691548";

const GVIZ_URL =
  `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

const INTERVAL_MS = 3000;
const SHOW_DEBUG = true;

/* -------- 工具函数 -------- */
function safeCell(rows, r, c) {
    if (!rows || !rows[r] || !rows[r].c) return null;
    const cell = rows[r].c[c];
    if (!cell) return null;
    return cell.v ?? cell.f ?? null;
}
function formatScore(v) {
    if (v === null || v === undefined || v === "") return "—";
    const n = Number(v);
    if (!isNaN(n)) return (n % 1 === 0) ? n.toFixed(0) : n.toFixed(2);
    return String(v);
}
function parseGviz(text){
    return JSON.parse(
        text.replace(/^[\s\S]*?setResponse\(/, "").replace(/\);?\s*$/, "")
    );
}

/* ★ 自动侦测 B 列位置（最关键修复点）★ */
function detectBaseCol(rows){
    let maxCol = 0;
    rows.forEach(r => { if (r.c && r.c.length > maxCol) maxCol = r.c.length; });

    for (let col = 0; col < maxCol; col++) {
        const v = safeCell(rows, 0, col);
        if (v && isNaN(Number(v))) return col;
    }
    return 0;
}

async function updateScore() {
    try {
        const res = await fetch(GVIZ_URL, { cache: "no-store" });
        const txt = await res.text();
        const data = parseGviz(txt);
        const rows = data.table.rows;

        const baseCol = detectBaseCol(rows);

        /* 第一~四排 */
        document.getElementById("sheetTitle").innerText = safeCell(rows, 0, baseCol) || "—";
        document.getElementById("nameEng").innerText  = safeCell(rows, 1, baseCol) || "—";
        document.getElementById("nameChn").innerText  = safeCell(rows, 2, baseCol) || "—";
        document.getElementById("club").innerText     = safeCell(rows, 3, baseCol) || "—";

        /* 第六排的分数（你指定：B6 / C6 / C7） */
        const A = safeCell(rows, 5, baseCol);
        const B = safeCell(rows, 5, baseCol + 1);
        const P = safeCell(rows, 6, baseCol + 1);

        document.getElementById("valA").innerText = formatScore(A);
        document.getElementById("valB").innerText = formatScore(B);
        document.getElementById("valPenalty").innerText = formatScore(P);

        /* 第八排：最终分数 B8 */
        const finalVal = safeCell(rows, 7, baseCol);
        document.getElementById("finalScore").innerText = formatScore(finalVal);

        document.getElementById("updatedAt").innerText = new Date().toLocaleString();

        if (SHOW_DEBUG) {
            document.getElementById("debugBox").style.display = "block";
            document.getElementById("netStatus").innerText =
                "baseCol = " + baseCol;
            document.getElementById("netError").innerText =
                `B1=${safeCell(rows,0,baseCol)}\nB2=${safeCell(rows,1,baseCol)}\nB3=${safeCell(rows,2,baseCol)}\nB4=${safeCell(rows,3,baseCol)}\nB6=${A}\nC6=${B}\nC7=${P}\nB8=${finalVal}`;
        }

    } catch (err) {
        console.error(err);
        document.getElementById("netError").innerText = "错误: " + err;
    }
}

updateScore();
setInterval(updateScore, INTERVAL_MS);
</script>

</body>
</html>
