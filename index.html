<script>
/* 智能映射版 fetch + applyTable
   - 自动跳过左侧序号列（若存在）
   - 在标签行里查找包含关键词的列来确定 A/B/penalty 列
   - 映射 B2..D8 → 页面
*/
const SPREADSHEET_ID = "1qGA-x86Xt7qEXwzO_Nx0RwaFr7yO2x3kocqA_nTfA0w";
const GID = "387691548";
const INTERVAL_MS = 5000;
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
const SHOW_DEBUG = true;

if (SHOW_DEBUG) {
  const d = document.getElementById('debugBox');
  if (d) { d.style.display='block'; document.getElementById('gvizLink').innerText = GVIZ_URL; document.getElementById('gvizLink').href = GVIZ_URL; }
}

function setStatus(txt){ if (SHOW_DEBUG) document.getElementById('netStatus').innerText = '状态: ' + txt; }
function setError(txt){ if (SHOW_DEBUG) document.getElementById('netError').innerText = txt; console.error(txt); }

function safeCellRaw(rows, r, c){
  if (!rows || !rows[r] || !rows[r].c) return null;
  const cell = rows[r].c[c];
  if (!cell) return null;
  if (cell.v !== undefined) return cell.v;
  if (cell.f !== undefined) return cell.f;
  return null;
}

// 判断是否为纯数字（包括空白视为非数字）
function isPureNumber(x){
  if (x === null || x === undefined) return false;
  // 去掉空格
  const s = String(x).trim();
  if (s === '') return false;
  // 判断是否完全为数字（包括小数）
  return !isNaN(Number(s));
}

// 在某一行里找到第一个「看起来像文本的单元」索引（跳过纯数字序号）
function findFirstTextColInRow(rows, rowIndex){
  if (!rows || !rows[rowIndex] || !rows[rowIndex].c) return null;
  const cols = rows[rowIndex].c;
  for (let j=0;j<cols.length;j++){
    const v = cols[j] && (cols[j].v !== undefined ? cols[j].v : cols[j].f);
    if (v === null || v === undefined) continue;
    // 如果不是纯数字就当文本
    if (!isPureNumber(v)) return j;
    // 但如果是数字但明显是我们需要的（例如 final value 3.00）不要跳过——这里只用于找姓名/学校
  }
  return null;
}

// 在某一行内按关键词查找列索引（返回对象映射）
function findLabelCols(rows, rowIndex){
  const result = {aCol: null, bCol: null, penaltyCol: null, finalLabelCol: null};
  if (!rows || !rows[rowIndex] || !rows[rowIndex].c) return result;
  const cols = rows[rowIndex].c;
  for (let j=0;j<cols.length;j++){
    const v = cols[j] && (cols[j].v !== undefined ? String(cols[j].v) : String(cols[j].f || ''));
    if (!v) continue;
    const low = v.toLowerCase();
    if (low.indexOf('a组') !== -1 || low.indexOf('a组得分') !== -1 || low.indexOf('a组') !== -1) result.aCol = j;
    if (low.indexOf('b组') !== -1 || low.indexOf('b组得分') !== -1) result.bCol = j;
    if (low.indexOf('裁判') !== -1 || low.indexOf('扣分') !== -1 || low.indexOf('penalty') !== -1) result.penaltyCol = j;
    if (low.indexOf('final') !== -1 || low.indexOf('最终得分') !== -1) result.finalLabelCol = j;
  }
  return result;
}

function formatScore(v){
  if (v === null || v === undefined || v === '') return '—';
  const n = Number(v);
  if (!isNaN(n)) {
    return (n % 1 === 0) ? n.toFixed(0) : n.toFixed(2);
  }
  return String(v);
}

function applyTableSmart(table){
  const rows = (table && table.rows) ? table.rows : [];
  // 保底：如果 rows 长度不足，直接退出
  if (!rows || rows.length < 2) {
    setError('表格行数太少，无法映射（需要至少 8 行预期结构）');
    return;
  }

  // 1) 自动找姓名（B2:D2）行的第一个文本列（跳过序号列）
  const nameEngCol = findFirstTextColInRow(rows, 1); // 对应 B2 行的“第一文本列”
  const nameEng = (nameEngCol !== null) ? safeCellRaw(rows,1,nameEngCol) : safeCellRaw(rows,1,0);

  const nameChnCol = findFirstTextColInRow(rows, 2);
  const nameChn = (nameChnCol !== null) ? safeCellRaw(rows,2,nameChnCol) : safeCellRaw(rows,2,0);

  const clubCol = findFirstTextColInRow(rows, 3);
  const club = (clubCol !== null) ? safeCellRaw(rows,3,clubCol) : safeCellRaw(rows,3,0);

  // 2) 在标签行（原 B5..D5）寻找明确的列（A/B/penalty/Final）
  // 我们尝试在 row index 4 (第五行) 找标签；如果没找到再在该行附近寻找
  let labelRowIndex = 4;
  if (!rows[labelRowIndex] || !rows[labelRowIndex].c) {
    // 找到第一个包含关键字的行
    for (let r = 0; r < Math.min(rows.length, 10); r++){
      const rr = rows[r];
      if (!rr || !rr.c) continue;
      const joined = rr.c.map(x => x && (x.v !== undefined ? String(x.v) : String(x.f || ''))).join(' ').toLowerCase();
      if (joined.indexOf('a组') !== -1 || joined.indexOf('final') !== -1 || joined.indexOf('裁判') !== -1) { labelRowIndex = r; break; }
    }
  }
  const labels = findLabelCols(rows, labelRowIndex);

  // 如果 labels 没有全部识别出来，我们也尝试在整行里找包含 'A组' 的列
  if (!labels.aCol || !labels.bCol || !labels.penaltyCol) {
    // 遍历 labelRowIndex 的每列去匹配关键字
    const rr = rows[labelRowIndex] && rows[labelRowIndex].c || [];
    for (let j=0;j<rr.length;j++){
      const v = rr[j] && (rr[j].v !== undefined ? String(rr[j].v) : String(rr[j].f || ''));
      if (!v) continue;
      const low = v.toLowerCase();
      if (!labels.aCol && (low.indexOf('a组') !== -1 || low.indexOf('a 组') !== -1)) labels.aCol = j;
      if (!labels.bCol && (low.indexOf('b组') !== -1 || low.indexOf('b 组') !== -1)) labels.bCol = j;
      if (!labels.penaltyCol && (low.indexOf('裁判') !== -1 || low.indexOf('扣分') !== -1 || low.indexOf('penalty') !== -1)) labels.penaltyCol = j;
      if (!labels.finalLabelCol && (low.indexOf('final') !== -1 || low.indexOf('最终得分') !== -1)) labels.finalLabelCol = j;
    }
  }

  // 3) 根据找到的列去读取数值行（labelRowIndex+1 -> 数值行）， final 行通常为 labelRowIndex+2 / +3，下面尝试读取
  const valueRowIndex = labelRowIndex + 1;
  const finalLabelRowIndex = labelRowIndex + 2;
  const finalValueRowIndex = labelRowIndex + 3;

  const valAraw = (labels.aCol !== null) ? safeCellRaw(rows, valueRowIndex, labels.aCol) : null;
  const valBraw = (labels.bCol !== null) ? safeCellRaw(rows, valueRowIndex, labels.bCol) : null;
  const valPenaltyRaw = (labels.penaltyCol !== null) ? safeCellRaw(rows, valueRowIndex, labels.penaltyCol) : null;

  const finalLabelRaw = (labels.finalLabelCol !== null) ? safeCellRaw(rows, finalLabelRowIndex, labels.finalLabelCol) : null;
  const finalValueRaw = safeCellRaw(rows, finalValueRowIndex, labels.finalLabelCol !== null ? labels.finalLabelCol : 0);

  // 写到页面
  document.getElementById('nameEng').innerText = nameEng || '—';
  document.getElementById('nameChn').innerText = nameChn || '—';
  document.getElementById('club').innerText = club || '—';

  document.getElementById('labelA').innerText = safeCellRaw(rows,labelRowIndex, labels.aCol) || 'A组得分';
  document.getElementById('labelB').innerText = safeCellRaw(rows,labelRowIndex, labels.bCol) || 'B组得分';
  document.getElementById('labelPenalty').innerText = safeCellRaw(rows,labelRowIndex, labels.penaltyCol) || '裁判长扣分';

  document.getElementById('valA').innerText = formatScore(valAraw);
  document.getElementById('valB').innerText = formatScore(valBraw);
  document.getElementById('valPenalty').innerText = formatScore(valPenaltyRaw);

  if (finalLabelRaw) document.getElementById('finalLabel').innerText = finalLabelRaw;
  document.getElementById('finalScore').innerText = formatScore(finalValueRaw);

  document.getElementById('updatedAt').innerText = (new Date()).toLocaleString();

  // Debug 输出：显示识别到的列索引，方便你检核
  const dbg = [
    `nameEngCol detected: ${nameEngCol}`,
    `nameChnCol detected: ${nameChnCol}`,
    `clubCol detected: ${clubCol}`,
    `labelRowIndex: ${labelRowIndex}`,
    `aCol: ${labels.aCol}`,
    `bCol: ${labels.bCol}`,
    `penaltyCol: ${labels.penaltyCol}`,
    `finalLabelCol: ${labels.finalLabelCol}`,
    `valueRowIndex: ${valueRowIndex}`,
    `finalLabelRowIndex: ${finalLabelRowIndex}`,
    `finalValueRowIndex: ${finalValueRowIndex}`
  ].join('\n');
  setStatus('解析并写入成功');
  if (SHOW_DEBUG) setError('Detected cols:\n' + dbg);
}

async function fetchAndUpdate(){
  setStatus('请求中...');
  setError('');
  try {
    const res = await fetch(GVIZ_URL, {cache:'no-store'});
    setStatus('HTTP ' + res.status);
    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      setError('请求失败: HTTP ' + res.status + '\n' + txt.slice(0,800));
      return;
    }
    const txt = await res.text();
    const jsonText = txt.replace(/^[\s\S]*?google\.visualization\.Query\.setResponse\(/, '').replace(/\);?\s*$/, '');
    const data = JSON.parse(jsonText);
    if (!data || !data.table) {
      setError('返回数据不包含 table，可能未发布或权限问题，返回片段:\n' + txt.slice(0,500));
      return;
    }
    applyTableSmart(data.table);
  } catch (err) {
    setError('Fetch/解析异常: ' + err.toString());
  }
}

fetchAndUpdate();
setInterval(fetchAndUpdate, INTERVAL_MS);
</script>
